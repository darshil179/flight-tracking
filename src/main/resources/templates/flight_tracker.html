<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Route Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        #map {
            height: 600px;
            width: 100%;
            border-radius: 12px;
            border: 2px solid #4a5568;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
    <!-- Leaflet CSS and JS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-8">

    <div class="container flex flex-col items-center justify-center min-h-screen">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-400 mb-2">Flight Route Tracker</h1>
            <p class="text-lg text-gray-400">Enter a flight number to view its route.</p>
        </header>

        <!-- Search and Info Section -->
        <div class="w-full max-w-2xl bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <input id="flight-number-input" type="text" placeholder="Enter Flight Number (e.g., AI101)"
                       class="flex-1 w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-transparent focus:border-blue-500 focus:outline-none transition-colors">
                <button id="search-button"
                        class="w-full sm:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105">
                    Search Flight
                </button>
            </div>
            <div id="status-message" class="mt-4 text-center text-gray-300">
                <p>Try searching for **AI101**, **BA249**, or **SQ321** to see an example.</p>
            </div>
        </div>

        <!-- Map Container -->
        <div id="map"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mapElement = document.getElementById('map');
            const statusMessage = document.getElementById('status-message');
            const searchButton = document.getElementById('search-button');
            const flightNumberInput = document.getElementById('flight-number-input');
            let map = null;
            let flightPathLayer = null;

            // Initialize the map with a default view
            function initializeMap() {
                if (map) {
                    map.remove();
                }
                map = L.map(mapElement).setView([20, 0], 2); // Center on the world
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            }

            // Function to fetch and display flight data
            async function fetchFlightData(flightNumber) {
                statusMessage.innerHTML = `<p>Fetching data for flight **${flightNumber.toUpperCase()}**...</p>`;
                try {
                    const response = await fetch(`/flight-route?flightNumber=${flightNumber}`);
                    if (!response.ok) {
                        if (response.status === 404) {
                            statusMessage.innerHTML = `<p class="text-red-400">Error: Flight number **${flightNumber.toUpperCase()}** not found.</p>`;
                            if (flightPathLayer) flightPathLayer.remove();
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const routeData = await response.json();
                    
                    if (routeData.data && routeData.data.length > 0) {
                        const flightInfo = routeData.data[0];
                        const fromAirport = flightInfo.departure.airport;
                        const toAirport = flightInfo.arrival.airport;

                        // Check if live data exists
                        if (flightInfo.live) {
                            const liveLat = flightInfo.live.latitude;
                            const liveLng = flightInfo.live.longitude;
                            
                            // Remove previous flight path if it exists
                            if (flightPathLayer) {
                                map.removeLayer(flightPathLayer);
                            }
                            
                            // Create and add the new polyline
                            // NOTE: The current API response doesn't provide a full path, just a single live point.
                            // We will just draw a marker at the live position for now.
                            flightPathLayer = L.marker([liveLat, liveLng]).addTo(map).bindPopup(`<b>Live Position</b>`).openPopup();
                            
                            // Adjust the map view to fit the entire route
                            map.setView([liveLat, liveLng], 5);
                            
                            statusMessage.innerHTML = `<p>Live position for flight **${flightInfo.flight.icao}** loaded. From **${fromAirport}** to **${toAirport}**</p>`;

                        } else {
                            statusMessage.innerHTML = `<p>No live flight data found for this code. From **${fromAirport}** to **${toAirport}**</p>`;
                            if (flightPathLayer) flightPathLayer.remove();
                        }
                    } else {
                        statusMessage.innerHTML = `<p>No flight route data found for this code.</p>`;
                        if (flightPathLayer) flightPathLayer.remove();
                    }
                } catch (error) {
                    console.error('Error fetching flight data:', error);
                    statusMessage.innerHTML = `<p class="text-red-400">Error: Could not retrieve flight data.</p>`;
                }
            }
            
            // Add event listener for the search button
            searchButton.addEventListener('click', () => {
                const flightNumber = flightNumberInput.value.trim();
                if (flightNumber) {
                    fetchFlightData(flightNumber);
                } else {
                    statusMessage.innerHTML = `<p class="text-red-400">Please enter a flight number.</p>`;
                }
            });

            initializeMap();
        });
    </script>
</body>
</html>
